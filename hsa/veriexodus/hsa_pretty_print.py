from cisco_translator import *
from openflow_translator import *
from headerspace.hs import *
from utils.wildcard import *
import sys

def printRules(rules):
    printRulesToFile(sys.stdout, rules)

def printTFToFile(afile, tf):
    for rule in tf.rules:
        printRuleToFile(afile, rule)

def printRulesToFile(afile, rules):
    for rule in rules:
        printRuleToFile(afile, rule)

def printRuleToFile(afile, rule):
    ''' TODO: -verbose options :-) '''

    '''
    afile.write("in_ports: %s, match: %s => ((h & %s) | %s, %s)" % \
        (rule['in_ports'], rule['match'], rule['mask'], \
         rule['rewrite'], rule['out_ports']))
    '''
    afile.write("in_ports: %s\n, match: %s\n, mask: %s\n, rewrite: %s\n, out_ports: %s\n" % \
        (rule['in_ports'], parseWildcard(rule["match"]), parseWildcard(rule['mask']), \
         parseWildcard(rule['rewrite']), rule['out_ports']))
    afile.write("\n")
    afile.write("--------------------\n")

    # debug
    if 'orig_rule_match' in rule.keys():
        r = rule['orig_rule_match']
        afile.write('---------Original Match -----------')
        afile.write(parseWildcard(r))
        afile.write('----------------------------')

    #for debugging
    '''if 'generated' in rule.keys():
        afile.write('---------Generated By-----------')
        r = rule['generated']
        afile.write("in_ports: %s\n, match: %s\n, mask: %s\n, rewrite: %s\n, out_ports: %s\n" % \
        (r['in_ports'], parseWildcard(r['match']), parseWildcard(r['mask']), \
         parseWildcard(r['rewrite']), r['out_ports']))
        afile.write('----------------------------')
    if 'shadowed' in rule.keys():
        afile.write('---------Shadowed By-----------')
        s = rule['shadowed']
        for r in s:
            afile.write("in_ports: %s\n, match: %s\n, mask: %s\n, rewrite: %s\n, out_ports: %s\n" % \
            (r['in_ports'], parseWildcard(r['match']), parseWildcard(r['mask']), \
             parseWildcard(r['rewrite']), r['out_ports']))
        afile.write('----------------------------')
    '''
    afile.write('********************************************************\n')


def pkt_format():
    pkt_format = {}
    pkt_format["vlan_pos"] = 0
    pkt_format["ip_src_pos"] = 2
    pkt_format["ip_dst_pos"] = 6
    pkt_format["ip_proto_pos"] = 10
    pkt_format["transport_src_pos"] = 11
    pkt_format["transport_dst_pos"] = 13
    pkt_format["transport_ctrl_pos"] = 15
    pkt_format["dl_src_pos"] = 16
    pkt_format["dl_dst_pos"] = 22
    pkt_format["dl_proto_pos"] = 28
    #
    pkt_format["vlan_len"] = 2
    pkt_format["ip_src_len"] = 4
    pkt_format["ip_dst_len"] = 4
    pkt_format["ip_proto_len"] = 1
    pkt_format["transport_src_len"] = 2
    pkt_format["transport_dst_len"] = 2
    pkt_format["transport_ctrl_len"] = 1
    pkt_format["dl_src_len"] = 6
    pkt_format["dl_dst_len"] = 6
    pkt_format["dl_proto_len"] = 2
    #
    pkt_format["length"] = 30
    return pkt_format


def parseWildcard(w):
    fields = ["vlan","dl_src","dl_dst","dl_proto","ip_src","ip_dst","ip_proto","transport_src",\
      "transport_dst", "transport_ctrl"]
    return wc_header_to_parsed_string(pkt_format(), fields, w)
